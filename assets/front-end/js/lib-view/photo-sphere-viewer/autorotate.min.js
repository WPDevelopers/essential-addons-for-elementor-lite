!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("three"),require("@photo-sphere-viewer/core")):"function"==typeof define&&define.amd?define(["exports","three","@photo-sphere-viewer/core"],e):e(((t="undefined"!=typeof globalThis?globalThis:t||self).PhotoSphereViewer=t.PhotoSphereViewer||{},t.PhotoSphereViewer.AutorotatePlugin={}),t.THREE,t.PhotoSphereViewer)}(this,(function(t,e,i){"use strict";var s=Object.defineProperty,o=Object.getOwnPropertyDescriptor,n=Object.getOwnPropertyNames,r=Object.prototype.hasOwnProperty,a=(t,e)=>{for(var i in e)s(t,i,{get:e[i],enumerable:!0})},h=()=>i,l={};a(l,{AutorotatePlugin:()=>S,events:()=>c});var p=h(),u=h(),c={};a(c,{AutorotateEvent:()=>g});var d=h(),v=class t extends d.TypedEvent{constructor(e){super(t.type),this.autorotateEnabled=e}};v.type="autorotate";var g=v,m=class extends u.AbstractButton{constructor(t){super(t,{className:"psv-autorotate-button",hoverScale:!0,collapsable:!0,tabbable:!0,icon:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 41 41" overflow="visible"><g fill="currentColor" transform-origin="center" transform="scale(1.3)"><path d="M40.5 14.1c-.1-.1-1.2-.5-2.899-1-.101 0-.2-.1-.2-.2C34.5 6.5 28 2 20.5 2S6.6 6.5 3.7 12.9c0 .1-.1.1-.2.2-1.7.6-2.8 1-2.9 1l-.6.3v12.1l.6.2c.1 0 1.1.4 2.7.9.1 0 .2.1.2.199C6.3 34.4 12.9 39 20.5 39c7.601 0 14.101-4.6 16.9-11.1 0-.101.1-.101.2-.2 1.699-.6 2.699-1 2.8-1l.6-.3V14.3l-.5-.2zM20.5 4c5.8 0 10.9 3 13.8 7.5.2.3-.1.6-.399.5-3.8-1-8.8-2-13.6-2-4.7 0-9.5 1-13.2 2-.3.1-.5-.2-.4-.5C9.7 7 14.8 4 20.5 4zm0 33c-5.9 0-11.1-3.1-14-7.899-.2-.301.1-.601.4-.5 3.9 1 8.9 2.1 13.6 2.1 5 0 9.9-1 13.601-2 .3-.1.5.2.399.5A16.422 16.422 0 0 1 20.5 37zm18.601-12.1c0 .1-.101.3-.2.3-2.5.9-10.4 3.6-18.4 3.6-7.1 0-15.6-2.699-18.3-3.6C2.1 25.2 2 25 2 24.9V16c0-.1.1-.3.2-.3 2.6-.9 10.6-3.6 18.2-3.6 7.5 0 15.899 2.7 18.5 3.6.1 0 .2.2.2.3v8.9z"/><path d="M18.7 24l6.4-3.7c.3-.2.3-.7 0-.8l-6.4-3.8c-.3-.2-.7 0-.7.4v7.4c0 .5.4.7.7.5z"/></g>\x3c!--Created by Nick Bluth from the Noun Project--\x3e</svg>\n',iconActive:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 41 41" overflow="visible"><g fill="currentColor" transform-origin="center" transform="scale(1.3)"><path d="M40.5 14.1c-.1-.1-1.2-.5-2.898-1-.102 0-.202-.1-.202-.2C34.5 6.5 28 2 20.5 2S6.6 6.5 3.7 12.9c0 .1-.1.1-.2.2-1.7.6-2.8 1-2.9 1l-.6.3v12.1l.6.2c.1 0 1.1.399 2.7.899.1 0 .2.101.2.199C6.3 34.4 12.9 39 20.5 39c7.602 0 14.102-4.6 16.9-11.1 0-.102.1-.102.199-.2 1.699-.601 2.699-1 2.801-1l.6-.3V14.3l-.5-.2zM6.701 11.5C9.7 7 14.8 4 20.5 4c5.8 0 10.9 3 13.8 7.5.2.3-.1.6-.399.5-3.799-1-8.799-2-13.6-2-4.7 0-9.5 1-13.2 2-.3.1-.5-.2-.4-.5zM25.1 20.3L18.7 24c-.3.2-.7 0-.7-.5v-7.4c0-.4.4-.6.7-.4l6.399 3.8c.301.1.301.6.001.8zm9.4 8.901A16.421 16.421 0 0 1 20.5 37c-5.9 0-11.1-3.1-14-7.898-.2-.302.1-.602.4-.5 3.9 1 8.9 2.1 13.6 2.1 5 0 9.9-1 13.602-2 .298-.1.5.198.398.499z"/></g>\x3c!--Created by Nick Bluth from the Noun Project--\x3e</svg>\n'}),this.plugin=this.viewer.getPlugin("autorotate"),this.plugin?.addEventListener(g.type,this)}destroy(){this.plugin?.removeEventListener(g.type,this),super.destroy()}isSupported(){return!!this.plugin}handleEvent(t){t instanceof g&&this.toggleActive(t.autorotateEnabled)}onClick(){this.plugin.isEnabled()&&(this.plugin.config.autostartOnIdle=!1),this.plugin.toggle()}};m.id="autorotate";var f=h(),y=e,w=f.utils.getConfigParser({autostartDelay:2e3,autostartOnIdle:!0,autorotateSpeed:f.utils.parseSpeed("2rpm"),autorotatePitch:null,autorotateZoomLvl:null,keypoints:null,startFromClosest:!0},{autostartOnIdle:(t,{rawConfig:e})=>t&&f.utils.isNil(e.autostartDelay)?(f.utils.logWarn("autostartOnIdle requires a non null autostartDelay"),!1):t,autorotateSpeed:t=>f.utils.parseSpeed(t),autorotatePitch:t=>f.utils.isNil(t)?null:f.utils.parseAngle(t,!0),autorotateZoomLvl:t=>f.utils.isNil(t)?null:y.MathUtils.clamp(t,0,100)});function _(t){return[t.yaw,t.pitch]}var S=class extends f.AbstractConfigurablePlugin{constructor(t,e){super(t,e),this.state={initialStart:!0,enabled:!1,idx:-1,curve:[],startStep:null,endStep:null,startTime:null,stepDuration:null,remainingPause:null,lastTime:null,tooltip:null},this.state.initialStart=!f.utils.isNil(this.config.autostartDelay)}init(){super.init(),this.video=this.viewer.getPlugin("video"),this.markers=this.viewer.getPlugin("markers"),this.config.keypoints&&(this.setKeypoints(this.config.keypoints),delete this.config.keypoints),this.viewer.addEventListener(f.events.StopAllEvent.type,this),this.viewer.addEventListener(f.events.BeforeRenderEvent.type,this),this.video||this.viewer.addEventListener(f.events.KeypressEvent.type,this)}destroy(){this.viewer.removeEventListener(f.events.StopAllEvent.type,this),this.viewer.removeEventListener(f.events.BeforeRenderEvent.type,this),this.viewer.removeEventListener(f.events.KeypressEvent.type,this),delete this.video,delete this.markers,delete this.keypoints,super.destroy()}handleEvent(t){switch(t.type){case f.events.StopAllEvent.type:this.stop();break;case f.events.BeforeRenderEvent.type:this.__beforeRender(t.timestamp);break;case f.events.KeypressEvent.type:t.key===f.CONSTANTS.KEY_CODES.Space&&this.viewer.state.keyboardEnabled&&(this.toggle(),t.preventDefault())}}setKeypoints(t){if(t){if(t.length<2)throw new f.PSVError("At least two points are required");this.keypoints=t.map(((t,e)=>{const i={position:null,markerId:null,pause:0,tooltip:null};let s;if("string"==typeof t?i.markerId=t:f.utils.isExtendedPosition(t)?s=t:(i.markerId=t.markerId,i.pause=t.pause,s=t.position,t.tooltip&&"object"==typeof t.tooltip?i.tooltip=t.tooltip:"string"==typeof t.tooltip&&(i.tooltip={content:t.tooltip})),i.markerId){if(!this.markers)throw new f.PSVError(`Keypoint #${e} references a marker but the markers plugin is not loaded`);const t=this.markers.getMarker(i.markerId);i.position=_(t.state.position)}else{if(!s)throw new f.PSVError(`Keypoint #${e} is missing marker or position`);i.position=_(this.viewer.dataHelper.cleanPosition(s))}return i}))}else this.keypoints=null;this.isEnabled()&&(this.stop(),this.start())}isEnabled(){return this.state.enabled}start(){this.isEnabled()||(this.viewer.stopAll(),this.keypoints?this.config.startFromClosest&&this.__shiftKeypoints():this.__animate(),this.state.initialStart=!1,this.state.enabled=!0,this.dispatchEvent(new g(!0)))}stop(){this.isEnabled()&&(this.__hideTooltip(),this.__reset(),this.viewer.stopAnimation(),this.viewer.dynamics.position.stop(),this.viewer.dynamics.zoom.stop(),this.state.enabled=!1,this.dispatchEvent(new g(!1)))}toggle(){this.isEnabled()?this.stop():this.start()}reverse(){this.isEnabled()&&!this.keypoints&&(this.config.autorotateSpeed=-this.config.autorotateSpeed,this.__animate())}__animate(){let t;t=f.utils.isNil(this.config.autorotateZoomLvl)?Promise.resolve(!0):this.viewer.animate({zoom:this.config.autorotateZoomLvl,speed:2*this.viewer.config.zoomSpeed+"rpm"}),t.then((t=>{t&&(this.viewer.dynamics.position.roll({yaw:this.config.autorotateSpeed<0},Math.abs(this.config.autorotateSpeed/this.viewer.config.moveSpeed)),this.viewer.dynamics.position.goto({pitch:this.config.autorotatePitch??this.viewer.config.defaultPitch},Math.abs(this.config.autorotateSpeed/this.viewer.config.moveSpeed)))}))}__reset(){this.state.idx=-1,this.state.curve=[],this.state.startStep=null,this.state.endStep=null,this.state.startTime=null,this.state.stepDuration=null,this.state.remainingPause=null,this.state.lastTime=null,this.state.tooltip=null}__beforeRender(t){(this.state.initialStart||this.config.autostartOnIdle)&&this.viewer.state.idleTime>0&&t-this.viewer.state.idleTime>this.config.autostartDelay&&this.start(),this.isEnabled()&&this.keypoints&&(this.state.startTime||(this.state.endStep=_(this.viewer.getPosition()),this.__nextStep(),this.state.startTime=t,this.state.lastTime=t),this.__nextFrame(t))}__shiftKeypoints(){const t=_(this.viewer.getPosition()),e=this.__findMinIndex(this.keypoints,(e=>f.utils.greatArcDistance(e.position,t)));this.keypoints.push(...this.keypoints.splice(0,e))}__incrementIdx(){this.state.idx++,this.state.idx===this.keypoints.length&&(this.state.idx=0)}__showTooltip(){const t=this.keypoints[this.state.idx];if(t.tooltip){const e=this.viewer.dataHelper.vector3ToViewerCoords(this.viewer.state.direction);this.state.tooltip=this.viewer.createTooltip({content:t.tooltip.content,position:t.tooltip.position,top:e.y,left:e.x})}else if(t.markerId){const e=this.markers.getMarker(t.markerId);e.showTooltip(),this.state.tooltip=e.tooltip}}__hideTooltip(){if(this.state.tooltip){const t=this.keypoints[this.state.idx];if(t.tooltip)this.state.tooltip.hide();else if(t.markerId){this.markers.getMarker(t.markerId).hideTooltip()}this.state.tooltip=null}}__nextPoint(){const t=[];if(-1===this.state.idx){const e=_(this.viewer.getPosition());t.push(e,e,this.keypoints[0].position,this.keypoints[1].position)}else for(let e=-1;e<3;e++){const i=this.state.idx+e<0?this.keypoints[this.keypoints.length-1]:this.keypoints[(this.state.idx+e)%this.keypoints.length];t.push(i.position)}const e=[new y.Vector2(t[0][0],t[0][1])];let i=0;for(let s=1;s<=3;s++){const o=t[s-1][0]-t[s][0];o>Math.PI?i+=1:o<-Math.PI&&(i-=1),0!==i&&1===s&&(e[0].x-=2*i*Math.PI,i=0),e.push(new y.Vector2(t[s][0]+2*i*Math.PI,t[s][1]))}const s=new y.SplineCurve(e).getPoints(48).map((t=>[t.x,t.y]));this.state.curve=s.slice(17,33),-1!==this.state.idx?(this.state.remainingPause=this.keypoints[this.state.idx].pause,this.state.remainingPause?this.__showTooltip():this.__incrementIdx()):this.__incrementIdx()}__nextStep(){0===this.state.curve.length&&(this.__nextPoint(),this.state.endStep[0]=f.utils.parseAngle(this.state.endStep[0])),this.state.startStep=this.state.endStep,this.state.endStep=this.state.curve.shift();const t=f.utils.greatArcDistance(this.state.startStep,this.state.endStep);this.state.stepDuration=1e3*t/Math.abs(this.config.autorotateSpeed),0===t&&this.__nextStep()}__nextFrame(t){const e=t-this.state.lastTime;if(this.state.lastTime=t,this.state.remainingPause){if(this.state.remainingPause=Math.max(0,this.state.remainingPause-e),this.state.remainingPause>0)return;this.__hideTooltip(),this.__incrementIdx(),this.state.startTime=t}let i=(t-this.state.startTime)/this.state.stepDuration;i>=1&&(this.__nextStep(),i=0,this.state.startTime=t),this.viewer.rotate({yaw:this.state.startStep[0]+(this.state.endStep[0]-this.state.startStep[0])*i,pitch:this.state.startStep[1]+(this.state.endStep[1]-this.state.startStep[1])*i})}__findMinIndex(t,e){let i=0,s=Number.MAX_VALUE;return t.forEach(((t,o)=>{const n=e(t);n<s&&(s=n,i=o)})),i}};S.id="autorotate",S.configParser=w,S.readonlyOptions=["keypoints"],(0,p.registerButton)(m,"start"),p.DEFAULTS.lang[m.id]="Automatic rotation",((t,e,i,a)=>{if(e&&"object"==typeof e||"function"==typeof e)for(let h of n(e))r.call(t,h)||h===i||s(t,h,{get:()=>e[h],enumerable:!(a=o(e,h))||a.enumerable})})(s(t,"__esModule",{value:!0}),l)}));